<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Folha de Ponto Mensal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #2b2b2b;
    }
    .container {
      max-width: 950px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    label, select, input {
      font-size: 16px;
      margin: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      margin: 10px 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #555;
    }
    .cadastro {
      text-align: center;
      margin-bottom: 15px;
    }
    input[type="text"] {
      padding: 5px;
      width: 200px;
    }
  </style>
</head>
<body>
  <div class="container" id="pontoContainer">
    <h1>Folha de Ponto Mensal</h1>

    <div class="cadastro">
      <h2>Cadastro de Funcion√°rios</h2>
      <input type="text" id="nomeFuncionario" placeholder="Nome do funcion√°rio">
      <input type="text" id="cargoFuncionario" placeholder="Cargo (opcional)">
      <button onclick="adicionarFuncionario()">‚ûï Adicionar</button>
      <select id="listaFuncionarios" onchange="selecionarFuncionario()">
        <option value="">Selecione um funcion√°rio</option>
      </select>
    </div>

    <div>
      <label for="mes">Selecione o m√™s:</label>
      <input type="month" id="mes" value="2025-11" onchange="gerarTabela()">
    </div>

    <table id="tabelaPonto">
      <thead>
        <tr>
          <th>Data</th>
          <th>Entrada</th>
          <th>Sa√≠da Intervalo</th>
          <th>Retorno</th>
          <th>Sa√≠da Final</th>
          <th>Total (h)</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="5">Total do M√™s</th>
          <th id="totalMes">0</th>
        </tr>
      </tfoot>
    </table>

    <div style="text-align:center;">
      <button onclick="salvarDados()">üíæ Salvar em Disco (CSV)</button>
      <button onclick="exportarPNG()">üñºÔ∏è Exportar em PNG</button>
      <button onclick="limparDados()">üßπ Limpar Dados</button>
    </div>

    <footer>
      Criado e licenciado por <b>Welson Soares</b>
    </footer>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    let funcionarioAtivo = null;

    function adicionarFuncionario() {
      const nome = document.getElementById('nomeFuncionario').value.trim();
      const cargo = document.getElementById('cargoFuncionario').value.trim();
      if (!nome) return alert('Digite o nome do funcion√°rio!');
      const funcionarios = JSON.parse(localStorage.getItem('funcionarios') || '[]');
      const existe = funcionarios.find(f => f.nome === nome);
      if (existe) return alert('Funcion√°rio j√° cadastrado!');
      funcionarios.push({ nome, cargo });
      localStorage.setItem('funcionarios', JSON.stringify(funcionarios));
      atualizarListaFuncionarios();
      document.getElementById('nomeFuncionario').value = '';
      document.getElementById('cargoFuncionario').value = '';
    }

    function atualizarListaFuncionarios() {
      const lista = document.getElementById('listaFuncionarios');
      lista.innerHTML = '<option value="">Selecione um funcion√°rio</option>';
      const funcionarios = JSON.parse(localStorage.getItem('funcionarios') || '[]');
      funcionarios.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.nome;
        opt.textContent = f.nome + (f.cargo ? ` - ${f.cargo}` : '');
        lista.appendChild(opt);
      });
    }

    function selecionarFuncionario() {
      funcionarioAtivo = document.getElementById('listaFuncionarios').value;
      if (funcionarioAtivo) gerarTabela();
    }

    function gerarTabela() {
      if (!funcionarioAtivo) return alert('Selecione um funcion√°rio!');
      const mesInput = document.getElementById('mes').value;
      const ano = parseInt(mesInput.split('-')[0]);
      const mes = parseInt(mesInput.split('-')[1]);
      const tbody = document.querySelector('#tabelaPonto tbody');
      tbody.innerHTML = '';
      const dias = new Date(ano, mes, 0).getDate();

      for (let i = 1; i <= dias; i++) {
        const dataStr = `${ano}-${String(mes).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${dataStr}</td>
          <td><input type="time" onchange="atualizar(${i})" id="entrada-${i}"></td>
          <td><input type="time" onchange="atualizar(${i})" id="saidaInt-${i}"></td>
          <td><input type="time" onchange="atualizar(${i})" id="retorno-${i}"></td>
          <td><input type="time" onchange="atualizar(${i})" id="saida-${i}"></td>
          <td id="total-${i}">0</td>
        `;
        tbody.appendChild(row);
      }
      carregarLocal();
    }

    function atualizar(dia) {
      const entrada = document.getElementById(`entrada-${dia}`).value;
      const saidaInt = document.getElementById(`saidaInt-${dia}`).value;
      const retorno = document.getElementById(`retorno-${dia}`).value;
      const saida = document.getElementById(`saida-${dia}`).value;

      if (entrada && saidaInt && retorno && saida) {
        const total =
          (calcMin(saidaInt) - calcMin(entrada)) +
          (calcMin(saida) - calcMin(retorno));
        document.getElementById(`total-${dia}`).innerText = (total / 60).toFixed(2);
      }
      salvarLocal();
      calcularTotalMes();
    }

    function calcMin(hora) {
      const [h, m] = hora.split(':').map(Number);
      return h * 60 + m;
    }

    function calcularTotalMes() {
      let total = 0;
      const dias = document.querySelectorAll('[id^=total-]');
      dias.forEach(td => total += parseFloat(td.innerText) || 0);
      document.getElementById('totalMes').innerText = total.toFixed(2);
    }

    function salvarLocal() {
      if (!funcionarioAtivo) return;
      const mes = document.getElementById('mes').value;
      const dados = {};
      const inputs = document.querySelectorAll('input[type="time"]');
      inputs.forEach(input => dados[input.id] = input.value);
      localStorage.setItem(`folha_${funcionarioAtivo}_${mes}`, JSON.stringify(dados));
    }

    function carregarLocal() {
      if (!funcionarioAtivo) return;
      const mes = document.getElementById('mes').value;
      const dados = JSON.parse(localStorage.getItem(`folha_${funcionarioAtivo}_${mes}`) || '{}');
      Object.keys(dados).forEach(id => {
        if (document.getElementById(id)) document.getElementById(id).value = dados[id];
      });
      calcularTotalMes();
    }

    function limparDados() {
      if (!funcionarioAtivo) return;
      const mes = document.getElementById('mes').value;
      localStorage.removeItem(`folha_${funcionarioAtivo}_${mes}`);
      gerarTabela();
    }

    function salvarDados() {
      const linhas = [['Data', 'Entrada', 'Sa√≠da Intervalo', 'Retorno', 'Sa√≠da Final', 'Total (h)']];
      const trs = document.querySelectorAll('#tabelaPonto tbody tr');
      trs.forEach(tr => {
        const cols = [...tr.querySelectorAll('td')].map(td => td.innerText || td.querySelector('input')?.value || '');
        linhas.push(cols);
      });
      const csv = linhas.map(l => l.join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `folha_${funcionarioAtivo}.csv`;
      a.click();
    }

    function exportarPNG() {
      html2canvas(document.getElementById('pontoContainer')).then(canvas => {
        const link = document.createElement('a');
        link.download = `folha_${funcionarioAtivo}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    atualizarListaFuncionarios();
  </script>
</body>
</html>
